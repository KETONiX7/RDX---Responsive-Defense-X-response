---
- name: Full RDX Response to Attack
  hosts: rdx-target
  become: true
  vars:
    attacker_ip: "192.168.1.100"  # Replace or pass via --extra-vars
  tasks:

    - name: Ensure nmap is installed
      apt:
        name: nmap
        state: present

    - name: 🔒 Block Attacker IP
      command: iptables -A INPUT -s {{ attacker_ip }} -j DROP

    - name: 🔍 Nmap Scan Attacker IP
      command: nmap -Pn -sV -T4 -oN /var/log/nmap_scan_{{ attacker_ip }}.txt {{ attacker_ip }}

    - name: 🔔 Send Slack Notification
      shell: "bash /opt/slack-alert.sh '{{ attacker_ip }}'"

    - name: 🎯 Deploy Cowrie Honeypot
      shell: |
        if [ ! -d /opt/cowrie ]; then
          git clone https://github.com/cowrie/cowrie.git /opt/cowrie
          cd /opt/cowrie
          apt update && apt install -y python3-venv
          python3 -m venv cowrie-env
          source cowrie-env/bin/activate
          pip install -r requirements.txt
        fi
        cd /opt/cowrie
        bin/cowrie start
